<?xml version="1.0" encoding="UTF-8" ?>
<userInterface name="cm_spoc.forms.TopUpCriterion">
  <group>Promotion</group>
  <label>TopUpCriterion</label>
  <metaVersion>4</metaVersion>
  <variableList>
    <variable name="model" type="leaf">
      <valueType>dstruct_cm_spoc.data.TopUpCriterion</valueType>
    </variable>
    <variable name="TopUpOriginPickList" type="leaf">
      <valueType>ui_cm_spoc.PickList</valueType>
    </variable>
    <variable name="TopUpOriginIterator" type="leaf">
      <flags enum-type="metadataFlag">ARRAY</flags>
      <valueType>ui_com.conceptwave.system.UserInterface</valueType>
    </variable>
  </variableList>
  <vformList>
    <vform name="Forms" type="frmui">
      <extends>ui_com.conceptwave.system.UserInterface/frmui_Forms</extends>
      <overlayList>
        <overlay name="Default" type="exov">
          <base>ui_com.conceptwave.system.UserInterface/frmui_Forms/vform_Default</base>
          <extends>ui_com.conceptwave.system.UserInterface/frmui_Forms/vform_Default</extends>
          <label>Default</label>
          <overrideList>
            <override name="VerticalLayout" type="elvlt">
              <width>750px</width>
              <elementList>
                <element name="Label" type="ellab">
                  <label>The subscriber must have made the following Top Ups</label>
                </element>
                <element name="SectionStack" type="elsectnstck">
                  <visibilityMode>multiple</visibilityMode>
                  <elementList>
                    <element name="Section" type="elsect">
                      <elementList>
                        <element name="SectionHeader" type="elsecth">
                          <label>Time Interval</label>
                        </element>
                        <element name="GridLayout" type="elgrd">
                          <alignment>center,center</alignment>
                          <numOfCols>4</numOfCols>
                          <width>200px</width>
                          <elementList>
                            <element name="TimeIntervalType" type="elslct">
                              <label>Time Interval Type</label>
                              <labelOrientation>left</labelOrientation>
                              <variable type="varPath">
                                <variablePathList>
                                  <variablePath>ui_cm_spoc.forms.TopUpCriterion/leaf_model</variablePath>
                                  <variablePath>dstruct_cm_spoc.data.TopUpCriterion/dstruct_TimeIntervalType</variablePath>
                                </variablePathList>
                              </variable>
                            </element>
                            <element name="RowSpacer" type="elrsp"/>
                            <element name="LessThan" type="elfld">
                              <labeAlign>left</labeAlign>
                              <label>Less than:</label>
                              <labelOrientation>left</labelOrientation>
                              <variable type="varPath">
                                <variablePathList>
                                  <variablePath>ui_cm_spoc.forms.TopUpCriterion/leaf_model</variablePath>
                                  <variablePath>dstruct_cm_spoc.data.TopUpCriterion/dstruct_LessThan</variablePath>
                                </variablePathList>
                              </variable>
                            </element>
                            <element name="Day" type="elslct">
                              <labelOrientation>right</labelOrientation>
                              <showLabel>false</showLabel>
                              <variable type="varPath">
                                <variablePathList>
                                  <variablePath>ui_cm_spoc.forms.TopUpCriterion/leaf_model</variablePath>
                                  <variablePath>dstruct_cm_spoc.data.TopUpCriterion/dstruct_Day</variablePath>
                                </variablePathList>
                              </variable>
                            </element>
                            <element name="InTheCurrent" type="elslct">
                              <labeAlign>left</labeAlign>
                              <label>In the current:</label>
                              <labelOrientation>left</labelOrientation>
                              <variable type="varPath">
                                <variablePathList>
                                  <variablePath>ui_cm_spoc.forms.TopUpCriterion/leaf_model</variablePath>
                                  <variablePath>dstruct_cm_spoc.data.TopUpCriterion/dstruct_InTheCurrent</variablePath>
                                </variablePathList>
                              </variable>
                            </element>
                          </elementList>
                        </element>
                      </elementList>
                    </element>
                    <element name="Section1" type="elsect">
                      <elementList>
                        <element name="SectionHeader1" type="elsecth">
                          <label>Evaluated Top Up Origins</label>
                        </element>
                        <element name="GridLayout1" type="elgrd">
                          <elementList>
                            <element name="EvaluatedTUOType" type="elslct">
                              <showLabel>false</showLabel>
                              <variable type="varPath">
                                <variablePathList>
                                  <variablePath>ui_cm_spoc.forms.TopUpCriterion/leaf_model</variablePath>
                                  <variablePath>dstruct_cm_spoc.data.TopUpCriterion/dstruct_EvaluatedTUOType</variablePath>
                                </variablePathList>
                              </variable>
                            </element>
                          </elementList>
                        </element>
                        <element name="TopUpOriginVL" type="elvlt">
                          <width>750px</width>
                          <elementList>
                            <element name="TopUpOriginFormFrame" type="elovf">
                              <formReference type="varPath">
                                <variablePathList>
                                  <variablePath>ui_cm_spoc.forms.TopUpCriterion/leaf_TopUpOriginPickList</variablePath>
                                  <variablePath>ui_cm_spoc.PickList/frmui_Forms</variablePath>
                                  <variablePath>ui_cm_spoc.PickList/frmui_Forms/exov_Default</variablePath>
                                </variablePathList>
                              </formReference>
                              <height>300px</height>
                              <variable type="varPath">
                                <variablePathList>
                                  <variablePath>ui_cm_spoc.forms.TopUpCriterion/leaf_TopUpOriginPickList</variablePath>
                                </variablePathList>
                              </variable>
                              <width>750px</width>
                            </element>
                          </elementList>
                        </element>
                      </elementList>
                    </element>
                    <element name="Section2" type="elsect">
                      <elementList>
                        <element name="SectionHeader2" type="elsecth">
                          <label>Top Up Threshold</label>
                        </element>
                        <element name="HorizontalLayout" type="elhlt">
                          <elementList>
                            <element name="MinimunAmount" type="elfld">
                              <labeAlign>left</labeAlign>
                              <label>Minimum amount:</label>
                              <labelOrientation>left</labelOrientation>
                              <variable type="varPath">
                                <variablePathList>
                                  <variablePath>ui_cm_spoc.forms.TopUpCriterion/leaf_model</variablePath>
                                  <variablePath>dstruct_cm_spoc.data.TopUpCriterion/dstruct_MinimunAmount</variablePath>
                                </variablePathList>
                              </variable>
                            </element>
                            <element name="MaximunAmount" type="elfld">
                              <labeAlign>left</labeAlign>
                              <label>Maximum amount:</label>
                              <labelOrientation>left</labelOrientation>
                              <variable type="varPath">
                                <variablePathList>
                                  <variablePath>ui_cm_spoc.forms.TopUpCriterion/leaf_model</variablePath>
                                  <variablePath>dstruct_cm_spoc.data.TopUpCriterion/dstruct_MaximunAmount</variablePath>
                                </variablePathList>
                              </variable>
                            </element>
                          </elementList>
                        </element>
                      </elementList>
                    </element>
                    <element name="Section3" type="elsect">
                      <elementList>
                        <element name="SectionHeader3" type="elsecth">
                          <label>Evaluated Concept</label>
                        </element>
                        <element name="EvaluatedConceptLayout1" type="elgrd">
                          <numOfCols>2</numOfCols>
                          <width>400px</width>
                          <elementList>
                            <element name="EvaluatedConceptType" type="elslct">
                              <labeAlign>left</labeAlign>
                              <label>Evaluated Concept Type</label>
                              <labelOrientation>left</labelOrientation>
                              <removeLabelLine>true</removeLabelLine>
                              <variable type="varPath">
                                <variablePathList>
                                  <variablePath>ui_cm_spoc.forms.TopUpCriterion/leaf_model</variablePath>
                                  <variablePath>dstruct_cm_spoc.data.TopUpCriterion/dstruct_EvaluatedConceptType</variablePath>
                                </variablePathList>
                              </variable>
                              <width>150px</width>
                            </element>
                            <element name="NumberOfTopUps" type="elfld">
                              <labeAlign>left</labeAlign>
                              <label>Number of Top Ups</label>
                              <labelOrientation>left</labelOrientation>
                              <variable type="varPath">
                                <variablePathList>
                                  <variablePath>ui_cm_spoc.forms.TopUpCriterion/leaf_model</variablePath>
                                  <variablePath>dstruct_cm_spoc.data.TopUpCriterion/dstruct_NumberOfTopUps</variablePath>
                                </variablePathList>
                              </variable>
                              <width>150px</width>
                            </element>
                            <element name="TotalTopUpAmount" type="elfld">
                              <labeAlign>left</labeAlign>
                              <label>Total Top Up amount</label>
                              <labelOrientation>left</labelOrientation>
                              <variable type="varPath">
                                <variablePathList>
                                  <variablePath>ui_cm_spoc.forms.TopUpCriterion/leaf_model</variablePath>
                                  <variablePath>dstruct_cm_spoc.data.TopUpCriterion/dstruct_TotalTopUpAmount</variablePath>
                                </variablePathList>
                              </variable>
                              <width>150px</width>
                            </element>
                            <element name="TaxesApplied" type="elchk">
                              <label>Taxes applied</label>
                              <labelOrientation>left</labelOrientation>
                              <variable type="varPath">
                                <variablePathList>
                                  <variablePath>ui_cm_spoc.forms.TopUpCriterion/leaf_model</variablePath>
                                  <variablePath>dstruct_cm_spoc.data.TopUpCriterion/dstruct_TaxesApplied</variablePath>
                                </variablePathList>
                              </variable>
                            </element>
                          </elementList>
                        </element>
                        <element name="LayoutSpacer" type="ellsp">
                          <height>30px</height>
                        </element>
                        <element name="VerticalLayout2" type="elvlt">
                          <elementList>
                            <element name="Separator" type="elsep">
                              <width>750px</width>
                            </element>
                            <element name="VerticalLayout1" type="elhlt">
                              <alignment>right,center</alignment>
                              <elementList>
                                <element name="OK" type="elbtn">
                                  <cellAlignment>right,center</cellAlignment>
                                  <clickMethod type="varPath">
                                    <variablePathList>
                                      <variablePath>ui_cm_spoc.forms.TopUpCriterion/uimthd_onClickOk</variablePath>
                                    </variablePathList>
                                  </clickMethod>
                                  <label>Accept</label>
                                </element>
                                <element name="Cancel" type="elbtn">
                                  <canSort>false</canSort>
                                  <cellAlignment>center,center</cellAlignment>
                                  <clickMethod type="varPath">
                                    <variablePathList>
                                      <variablePath>ui_cm_spoc.forms.TopUpCriterion/uimthd_onClickCancel</variablePath>
                                    </variablePathList>
                                  </clickMethod>
                                  <label>Cancel</label>
                                </element>
                              </elementList>
                            </element>
                          </elementList>
                        </element>
                      </elementList>
                    </element>
                  </elementList>
                </element>
              </elementList>
            </override>
          </overrideList>
        </overlay>
      </overlayList>
    </vform>
  </vformList>
  <methodList>
    <method name="cwLeafInitAction$TopUpOriginPickList" type="laction">
      <path>ui_cm_spoc.forms.TopUpCriterion/leaf_TopUpOriginPickList</path>
      <type>initializer</type>
      <script><![CDATA[
        /*var pl = new cm_spoc.PickList(null,this);
        pl.modelCallback = this.setModel;
        pl.availableItems = new DataObjectList();
        var itemFinder = new Finder("cm_spoc.topUpOriginPickListFinder");
        pl.availableItems = itemFinder.search();

        var listDS = this.model.TUCriterionTUOriginArrDS.ListDS;
        for(var i=0;i<listDS.length;i++){

            for(var j=0;j<pl.availableItems.length;j++){
                if(pl.availableItems[j].id ==  this.model.TUCriterionTUOriginArrDS.ListDS[i].specificationCode){
                    var item = pl.availableItems[j];
                    pl.selectedItems.addLast(item);
                    pl.availableItems.remove(item);
                    break;
                }
            }
        }
        this.TopUpOriginPickList=pl;
        return pl;*/

        var itemFinder = new Finder("cm_spoc.catalogItemFilteredFinder");
        itemFinder.searchDocument.baseItemCode = "base_TopUpOrigin";
        var result = itemFinder.search();
        var topUpCriterionSelected = this.parent.idSelected;
        //Reset the id for a new use
        this.parent.idSelected = null;
        if( topUpCriterionSelected == null )
            return cm_spoc.initPickList(this,result, this.model.TUCriterionTUOriginArrDS.List,"itemCode","itemCode");
        else
            return cm_spoc.initPickList(this,result, this.parent.model.PSTopUpCriterionArrDS.ListDS[topUpCriterionSelected].TUCriterionTUOriginArrDS.List,"itemCode","itemCode");
      ]]></script>
    </method>
    <method name="onClickCancel" type="uimthd">
      <script>this.parent.cwDialogClose();</script>
    </method>
    <method name="onClickOk" type="uimthd">
      <parameterList>
        <parameter name="data" type="rifp">
          <type>nmeta_com.conceptwave.system.Object</type>
        </parameter>
        <parameter name="errList" type="rifp">
          <type>nmeta_com.conceptwave.system.Object</type>
        </parameter>
      </parameterList>
      <script><![CDATA[
        this.model.TUCriterionTUOriginArrDS = cm_spoc.initInnerDS("base_TUCriterionTUOriginArr");
        for(var i=0;i<this.TopUpOriginPickList.selectedItems.length;i++){
            var item = this.TopUpOriginPickList.selectedItems[i];
            this.model.TUCriterionTUOriginArrDS.List[i] = this.TopUpOriginPickList.selectedItems[i].id;
        }
        this.parent.owner.model.PSTopUpCriterionArrDS.List[this.parent.owner.model.PSTopUpCriterionArrDS.List.length] =  this.model;
        this.parent.owner.model.PSTopUpCriterionArrDS.ListDS[this.parent.owner.model.PSTopUpCriterionArrDS.List.length] =  this.model;
        //this.parent.owner.model.PSTopUpCriterionArrDS.ListDS[this.parent.owner.model.PSTopUpCriterionArrDS.ListDS.length].TUCriterionTUOriginArrDS =  this.model.TUCriterionTUOriginArrDS;

        if(this.parent.owner.ListHistoric==null)
            this.parent.owner.ListHistoric = new DataObjectList();
        //Check if the label was added
        var exist = false;
        for(var j=0; j< this.parent.owner.ListHistoric.length; j++){
            if( this.parent.owner.ListHistoric[j].description == "Top Up" && this.parent.owner.ListHistoric[j].itemCode == this.model.specificationCode){
                 exist=true;
            }
        }
        if(!exist){
            var item = new cm_spoc.FinderSelectReferenceDS();
            item.description = "Top Up";
            item.itemCode = this.model.specificationCode;
            this.parent.owner.ListHistoric.addLast(item);
            this.parent.owner.ListHistoric.updateList;
        }

           /* if(this.parent.owner.ListHistoric==null)
                this.parent.owner.ListHistoric = new DataObjectList();
            for(var k=0; k< this.parent.owner.ListHistoric.length; k++){
                if( this.parent.owner.ListHistoric[k].description == "Top Up" &&  this.parent.owner.ListHistoric[k].itemCode)
                     this.parent.owner.ListHistoric.delete(k);
            }
            this.parent.owner.ListHistoric.updateList;
        }*/


        var valTIT=this.model.TimeIntervalType;
        var valDay=this.model.Day;
        var valITC=this.model.InTheCurrent;
        var valLT=this.model.LessThan;
        var valECT=this.model.EvaluatedConceptType;
        var valNOTU=this.model.NumberOfTopUps;
        var valTTUA=this.model.TotalTopUpAmount;
        var valTA=this.model.TaxesApplied;
        var errList=api_common.createFault();
        if (!valDay && valTIT=="R")
        {
            cm_spoc.rule_TUCDayMandatoryCondRule(this);
            return;
        }

        if (!valITC && valTIT=="A")
        {
             cm_spoc.rule_TUCInTheCurrentMandatoryCondRule(this);
             return;
        }

        if (!valLT && valTIT=="R")
        {
             cm_spoc.rule_TUCLessThanMandatoryCondRule(this);
             return;
        }

        if (!valNOTU && valECT=="N")
        {
             cm_spoc.rule_TUCNumberOfTopUpsMandatoryCondRule(this);
             return;
        }

        if (!valTA && valTTUA!=null)
        {
             cm_spoc.rule_TUCTaxesAppliedMandatoryCondRule(this);
             return;
        }

        if (!valTTUA && valECT=="T")
        {
             cm_spoc.rule_TUCTotalTopUpAmountMandatoryCondRule(this);
             return;
        }


        this.parent.cwDialogClose();
      ]]></script>
    </method>
    <method name="addErrorMessage" type="uimthd">
      <parameterList>
        <parameter name="data" type="rifp">
          <type>nmeta_com.conceptwave.system.Object</type>
        </parameter>
        <parameter name="params" type="rifp">
          <type>dtype_com.conceptwave.system.String</type>
        </parameter>
        <parameter name="code" type="rifp">
          <type>dtype_api_common.data.code</type>
        </parameter>
        <parameter name="text" type="rifp">
          <type>dtype_api_common.data.text</type>
        </parameter>
        <parameter name="faultType" type="rifp">
          <type>dtype_api_common.data.faultType</type>
        </parameter>
      </parameterList>
      <script><![CDATA[
        var m = this.message[this.message.length];
        m.code = code;
        if (text == null) {
            text = Global.translateText(code,null,params);
        }
        m.text = text;
        m.type = faultType == null ? 'F' : faultType;
        Global.logError(text);
      ]]></script>
    </method>
    <method name="popUpError" type="usrActionMethod">
      <dialogObject>ui_com.conceptwave.system.Dialog</dialogObject>
      <parameterList>
        <parameter name="idTopUp" type="rifp">
          <type>dtype_com.conceptwave.system.String</type>
        </parameter>
        <parameter name="option" type="rifp">
          <type>dtype_com.conceptwave.system.Integer</type>
        </parameter>
      </parameterList>
      <showInPopup>true</showInPopup>
      <script><![CDATA[
        var newDetail = new cm_spoc.forms.TopUpError();
        return newDetail;
      ]]></script>
    </method>
  </methodList>
</userInterface>